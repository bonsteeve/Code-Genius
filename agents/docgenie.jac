import from byllm.llm { Model }

import os;

include utils;

glob llm = Model(model_name="gemini-pro", verbose=False);

node docgenie {
    has repo_url: str;
    has repo_name: str = "";
    has file_tree: dict = {};
    has readme_summary: str = "";
    has code_graph: dict = {};
    has documentation: str = "";
    
    def generate_summary(repo_info: str) -> str by llm();
    
    can execute with supervisor entry {
        print("Starting DocGenie Agent...");
        
        repo_name = utils.git_utils.get_repository_name(self.repo_url);
        
        documentation = "# " + repo_name + " - Documentation\n\n";
        documentation += "> Generated by Codebase Genius\n\n";
        documentation += "---\n\n";
        
        documentation += "## Project Overview\n\n";
        if self.readme_summary != "" {
            documentation += self.readme_summary + "\n\n";
        } else {
            documentation += "This repository contains the source code for " + repo_name + ".\n\n";
        }
        documentation += "---\n\n";
        
        documentation += "## File Structure\n\n";
        if len(self.file_tree) > 0 {
            file_tree_diagram = utils.diagram_generator.generate_file_tree_diagram(self.file_tree);
            documentation += file_tree_diagram + "\n\n";
        }
        documentation += "---\n\n";
        
        if self.code_graph != {} {
            documentation += "## Code Analysis\n\n";
            
            if "statistics" in self.code_graph {
                stats = self.code_graph["statistics"];
                documentation += "### Statistics\n\n";
                documentation += "- **Total Files**: " + str(stats["total_files"]) + "\n";
                documentation += "- **Total Functions**: " + str(stats["total_functions"]) + "\n";
                documentation += "- **Total Classes**: " + str(stats["total_classes"]) + "\n\n";
            }
            
            if "relationship_analysis" in self.code_graph {
                documentation += "### Architecture Overview\n\n";
                documentation += self.code_graph["relationship_analysis"] + "\n\n";
            }
            
            if "files" in self.code_graph {
                all_classes = [];
                for file in self.code_graph["files"] {
                    for cls in file.classes {
                        all_classes.append(cls);
                    }
                }
                
                if len(all_classes) > 0 {
                    documentation += "### Class Hierarchy\n\n";
                    class_diagram = utils.diagram_generator.generate_class_hierarchy_diagram(all_classes);
                    documentation += class_diagram + "\n\n";
                }
            }
            
            documentation += "---\n\n";
        }
        
        if "files" in self.code_graph {
            documentation += "## Module Documentation\n\n";
            
            for file in self.code_graph["files"][:20] {
                documentation += "### " + file.file_path + "\n\n";
                
                if len(file.functions) > 0 {
                    documentation += "#### Functions\n\n";
                    for func in file.functions[:10] {
                        documentation += "- `" + func.name + "()` (Line " + str(func.line) + ")\n";
                    }
                    documentation += "\n";
                }
                
                if len(file.classes) > 0 {
                    documentation += "#### Classes\n\n";
                    for cls in file.classes[:10] {
                        documentation += "- `" + cls.name + "` (Line " + str(cls.line) + ")\n";
                    }
                    documentation += "\n";
                }
                
                documentation += "---\n\n";
            }
        }
        
        print("Generating final documentation summary...");
        summary_prompt = "Create a concise summary (2-3 paragraphs) of this codebase based on the following information:\n\n";
        summary_prompt += "Repository: " + repo_name + "\n";
        summary_prompt += "Files: " + str(self.code_graph.get("statistics", {}).get("total_files", 0)) + "\n";
        summary_prompt += "Functions: " + str(self.code_graph.get("statistics", {}).get("total_functions", 0)) + "\n";
        summary_prompt += "Classes: " + str(self.code_graph.get("statistics", {}).get("total_classes", 0)) + "\n";
        
        final_summary = self.generate_summary(summary_prompt);
        
        documentation += "## Summary\n\n";
        documentation += final_summary + "\n\n";
        
        self.documentation = documentation;
        
        print("DocGenie Agent completed");
        print("Documentation generated: " + str(len(documentation)) + " characters");
        
        report {
            "documentation": self.documentation
        };
    }
}

sem docgenie.generate_summary = "Create a concise summary (2-3 paragraphs) of the codebase based on the provided statistics and information.";
